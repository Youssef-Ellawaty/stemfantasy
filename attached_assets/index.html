<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دوري الفانتازي المدرسي</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --pink-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            --blue-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --purple-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            --gold-gradient: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            --bg-dark: #1a1d29;
            --card-dark: #2d3142;
            --text-light: #ffffff;
            --border-dark: #404654;
            --shadow-dark: 0 10px 30px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #8e44ad 50%, #3498db 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
            margin-bottom: 2rem;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .admin-access {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            font-size: 1.2rem;
        }

        .admin-access:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1) rotate(90deg);
        }

        .nav-tabs {
            background: var(--card-dark);
            padding: 0;
            margin: 2rem auto 0;
            max-width: 1200px;
            border-radius: 0;
            box-shadow: var(--shadow-dark);
            overflow: hidden;
            display: flex;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            color: var(--text-light);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--blue-gradient);
            transition: all 0.3s ease;
            z-index: -1;
        }

        .nav-tab.active::before,
        .nav-tab:hover::before {
            left: 0;
        }

        .nav-tab.active,
        .nav-tab:hover {
            color: white;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-light);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-dark);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-dark);
            color: var(--text-light);
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn-primary {
            background: var(--blue-gradient);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .btn-gold {
            background: var(--gold-gradient);
            color: #333;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .grid {
            display: grid;
            gap: 20px;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .card {
            background: var(--card-dark);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-dark);
            transition: all 0.3s ease;
            border: 1px solid var(--border-dark);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .player-card {
            background: var(--card-dark);
            border: 2px solid var(--border-dark);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: var(--text-light);
        }

        .player-card.selected {
            border-color: #4facfe;
            background: linear-gradient(135deg, var(--card-dark) 0%, #4facfe20 100%);
            transform: scale(1.02);
        }

        .player-card.captain {
            border-color: #ffd700;
            background: linear-gradient(135deg, var(--card-dark) 0%, #ffd70020 100%);
        }

        .player-card.triple-captain {
            border-color: #ffd700;
            background: linear-gradient(135deg, var(--card-dark) 0%, #ffd70040 100%);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .player-card:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-dark);
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .player-team {
            color: #bbb;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .player-price {
            color: #4facfe;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .player-stats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .formation {
            position: relative;
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background: #4CAF50; /* Solid, vibrant green */
            min-height: 650px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 3px solid #fff; /* White border for pitch */
            
            /* Basic Pitch Lines */
            background-image: 
                /* Halfway line */
                linear-gradient(to right, #fff 0%, #fff 100%),
                /* Center circle */
                radial-gradient(circle at center, transparent 70px, #fff 70px, #fff 72px, transparent 72px),
                /* Left Penalty Box (Outline only) */
                linear-gradient(to right, #fff 0%, #fff 100%), /* Top line */
                linear-gradient(to bottom, #fff 0%, #fff 100%), /* Left line */
                linear-gradient(to left, #fff 0%, #fff 100%), /* Bottom line */
                /* Right Penalty Box (Outline only) */
                linear-gradient(to right, #fff 0%, #fff 100%), /* Top line */
                linear-gradient(to bottom, #fff 0%, #fff 100%), /* Right line */
                linear-gradient(to left, #fff 0%, #fff 100%); /* Bottom line */

            background-position: 
                center,
                center,
                10px calc(50% - 75px), /* Left penalty box top */
                10px 50%, /* Left penalty box left */
                10px calc(50% + 75px), /* Left penalty box bottom */
                calc(100% - 10px) calc(50% - 75px), /* Right penalty box top */
                calc(100% - 10px) 50%, /* Right penalty box right */
                calc(100% - 10px) calc(50% + 75px); /* Right penalty box bottom */

            background-size: 
                100% 2px, /* Halfway line */
                100% 100%, /* Center circle, full size for proper positioning */
                150px 2px, /* Left penalty box top */
                2px 150px, /* Left penalty box left */
                150px 2px, /* Left penalty box bottom */
                150px 2px, /* Right penalty box top */
                2px 150px, /* Right penalty box right */
                150px 2px; /* Right penalty box bottom */

            background-repeat: no-repeat;
        }

        .formation-position {
            position: absolute; /* Add absolute positioning */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .goalkeeper { top: 85%; left: 50%; transform: translateX(-50%); } /* Bottom center */
        .defender { top: 65%; left: 50%; transform: translateX(-50%); } /* Above GK, center */
        .midfielder-1 { top: 45%; left: 40%; transform: translateX(-50%); } /* Midfielder 1, left of center */
        .midfielder-2 { top: 45%; left: 60%; transform: translateX(-50%); } /* Midfielder 2, right of center */
        .forward { top: 10%; left: 50%; transform: translateX(-50%); } /* Top center */
        .substitute-1 { top: 30%; left: 15%; transform: translateX(-50%); } /* Sub1 raised even more, above halfway, left */
        .substitute-2 { top: 50%; left: 15%; transform: translateX(-50%); } /* Sub2 raised even more, below halfway, left */

        .position-slot {
            /* Ensure no default text or content is unexpectedly displayed here */
            width: 80px;
            height: 80px;
            border: 3px solid #fff; /* White solid border for empty slot */
            border-radius: 5px; /* Maintaining rectangular with slight roundness */
            display: flex;
            align-items: center;
            justify-content: center;
            background: #282c34; /* Dark gray background */
            color: white; /* White text for player position */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .position-slot.filled {
            border: 3px solid #ffd700; /* Gold border for filled slot */
            background: rgba(255,215,0,0.2); /* Goldish background */
        }

        .position-slot.triple-captain {
            border: 3px solid #ffd700; /* Gold border for triple captain */
            background: rgba(255,215,0,0.4);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        .position-slot:hover {
            border-color: rgba(255,255,255,0.8); /* Slightly brighter white on hover for empty */
            background: rgba(255,255,255,0.1); /* Slight white transparency on hover for empty */
            transform: scale(1.1);
        }

        .position-slot.filled:hover {
            border-color: #ffd700; /* Maintain gold border on hover for filled */
            background: rgba(255,215,0,0.3); /* Slightly brighter goldish background on hover for filled */
        }

        .position-slot.player-removed {
            opacity: 0.4;
            border-color: var(--danger-gradient);
            background: rgba(255,107,107,0.2);
        }

        .position-slot.player-added {
            border-color: var(--success-gradient);
            background: rgba(76,201,240,0.2);
        }

        .budget-info {
            background: var(--warning-gradient);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: var(--shadow-dark);
        }

        .power-ups {
            background: var(--gold-gradient);
            color: #333;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-dark);
        }

        .power-up-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
        }

        .power-up-item:last-child {
            margin-bottom: 0;
        }

        .power-up-used {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .leaderboard {
            background: var(--card-dark);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-dark);
        }

        .leaderboard-header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-dark);
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: var(--text-light);
            min-width: 40px;
        }

        .rank.gold { color: #ffd700; }
        .rank.silver { color: #c0c0c0; }
        .rank.bronze { color: #cd7f32; }

        .user-info {
            flex: 1;
            margin: 0 20px;
        }

        .username {
            font-weight: bold;
            color: var(--text-light);
        }

        .points {
            font-weight: bold;
            color: #4facfe;
            font-size: 1.1rem;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: var(--card-dark);
            border-radius: 15px;
            padding: 40px;
            box-shadow: var(--shadow-dark);
            text-align: center;
            border: 1px solid var(--border-dark);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-dark);
            border-radius: 15px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-dark);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-dark);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 20px;
            background: var(--border-dark);
            border: none;
            border-radius: 25px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            background: var(--blue-gradient);
        }

        .match-card {
            background: var(--card-dark);
            border: 2px solid var(--border-dark);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .match-card:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-info {
            text-align: center;
            color: #bbb;
            font-size: 0.9rem;
        }

        .match-score {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #4facfe;
        }

        .match-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .match-status.upcoming {
            background: var(--warning-gradient);
            color: white;
        }

        .match-status.finished {
            background: var(--success-gradient);
            color: white;
        }

        .round-section {
            margin-bottom: 30px;
        }

        .round-header {
            background: var(--primary-gradient);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .p-20 { padding: 20px; }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .formation {
                min-height: 400px; /* Further adjust height for smaller mobile */
                margin: 10px auto;
                padding: 5px; /* Reduce padding even more for mobile */
                /* Adjust background-size for lines on mobile if needed, keeping it simple */
                background-size: 
                    100% 1px, /* Halfway line */
                    100% 100%, 
                    80px 1px, /* Penalty box lines */
                    1px 80px,
                    80px 1px,
                    80px 1px,
                    1px 80px,
                    80px 1px; 
            }
            
            .position-slot {
                width: 50px; /* Even smaller slots for very small screens */
                height: 50px;
                font-size: 0.6rem;
            }

            /* Adjust specific player positions for mobile responsiveness */
            .goalkeeper {
                top: 85%;
                left: 50%;
                transform: translateX(-50%);
            }

            .defender {
                top: 65%;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                flex-direction: row;
                gap: 5px;
            }

            .midfielder-1 {
                top: 45%; /* Midfielder 1 */
                left: 40%;
                transform: translateX(-50%);
                display: flex;
                flex-direction: row;
                gap: 5px;
            }

            .midfielder-2 {
                top: 45%; /* Midfielder 2, same top as mid1 */
                left: 60%;
                transform: translateX(-50%);
                display: flex;
                flex-direction: row;
                gap: 5px;
            }

            .forward {
                top: 10%;
                left: 50%;
                transform: translateX(-50%);
            }

            .substitute-1 {
                top: 40%; /* Sub1 above halfway, left */
                left: 15%;
                transform: translateX(-50%);
            }

            .substitute-2 {
                top: 60%; /* Sub2 below halfway, left */
                left: 15%;
                transform: translateX(-50%);
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }

        .transfers-section {
            background: var(--card-dark);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-dark);
        }

        .transfers-header {
            background: var(--primary-gradient);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .transfer-info {
            background: rgba(79, 172, 254, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <h2 style="color: var(--text-light); margin-bottom: 30px;">🏆 دوري الفانتازي المدرسي</h2>
        
        <div id="loginForm">
            <h3 style="margin-bottom: 20px;">تسجيل الدخول</h3>
            <div class="form-group">
                <input type="text" id="loginUsername" class="form-control" placeholder="اسم المستخدم">
            </div>
            <div class="form-group">
                <input type="password" id="loginPassword" class="form-control" placeholder="كلمة المرور">
            </div>
            <button onclick="login()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;">دخول</button>
            <button onclick="showRegister()" class="btn btn-warning" style="width: 100%;">إنشاء حساب جديد</button>
        </div>

        <div id="registerForm" class="hidden">
            <h3 style="margin-bottom: 20px;">إنشاء حساب جديد</h3>
            <div class="form-group">
                <input type="text" id="regUsername" class="form-control" placeholder="اسم المستخدم">
            </div>
            <div class="form-group">
                <input type="password" id="regPassword" class="form-control" placeholder="كلمة المرور">
            </div>
            <div class="form-group">
                <input type="text" id="regTeamName" class="form-control" placeholder="اسم الفريق">
            </div>
            <button onclick="register()" class="btn btn-success" style="width: 100%; margin-bottom: 10px;">إنشاء الحساب</button>
            <button onclick="showLogin()" class="btn btn-warning" style="width: 100%;">العودة لتسجيل الدخول</button>
        </div>
    </div>

    <!-- الواجهة الرئيسية -->
    <div id="mainApp" class="hidden">
        <div class="header">
            <button class="admin-access" onclick="showAdminLogin()">⚙️</button>
            <h1>🏆 دوري الفانتازي المدرسي</h1>
            <p>مرحباً <span id="currentUser"></span> | فريق: <span id="currentTeam"></span></p>
            <button onclick="logout()" class="btn btn-danger" style="margin-top: 10px;">تسجيل خروج</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('teamFormation')">🔥 تشكيلتي</button>
            <button class="nav-tab" onclick="showTab('matches')">⚽ المباريات</button>
            <button class="nav-tab" onclick="showTab('leaderboard')">🏆 الترتيب</button>
            <button class="nav-tab" onclick="showTab('playerStats')">📊 الإحصائيات</button>
        </div>

        <div class="container">
            <!-- تشكيلة الفريق -->
            <div id="teamFormation" class="tab-content active">
                <div class="budget-info">
                    الميزانية المتبقية: <span id="remainingBudget">45.0</span> مليون
                </div>

                <div class="power-ups">
                    <h4 style="margin-bottom: 15px;">💎 البطاقات الخاصة</h4>
                    <div class="power-up-item" id="tripleCaptainCard">
                        <span>👑 التريبل كابتن (نقاط × 3)</span>
                        <button id="tripleCaptainBtn" class="btn btn-gold" onclick="useTripleCaptain()">استخدام</button>
                    </div>
                    <div class="power-up-item" id="benchBoostCard">
                        <span>🚀 البينش بوست (نقاط البدلاء)</span>
                        <button id="benchBoostBtn" class="btn btn-gold" onclick="useBenchBoost()">استخدام</button>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>تشكيلة فريقك</h3>
                            <button class="btn btn-primary" id="toggleTransferModeBtn" onclick="toggleTransferMode()">إدارة الانتقالات</button>
                        </div>
                        <div class="formation">
                            <div class="formation-position goalkeeper">
                                <div class="position-slot" data-position="goalkeeper" onclick="handlePlayerSlotClick('goalkeeper')">
                                </div>
                                <small>حارس المرمى</small>
                            </div>
                            
                            <div class="formation-position defender">
                                <div class="position-slot" data-position="defender" onclick="handlePlayerSlotClick('defender')">
                                </div>
                                <small>مدافع</small>
                            </div>
                            
                            <div class="formation-position midfielder-1">
                                <div class="position-slot" data-position="midfielder1" onclick="handlePlayerSlotClick('midfielder1')">
                                    <span>وسط</span>
                                </div>
                                <small>وسط أول</small>
                            </div>
                            
                            <div class="formation-position midfielder-2">
                                <div class="position-slot" data-position="midfielder2" onclick="handlePlayerSlotClick('midfielder2')">
                                    <span>وسط</span>
                                </div>
                                <small>وسط ثاني</small>
                            </div>
                            
                            <div class="formation-position forward">
                                <div class="position-slot" data-position="forward" onclick="handlePlayerSlotClick('forward')">
                                    <span>مهاجم</span>
                                </div>
                                <small>مهاجم</small>
                            </div>
                            
                            <div class="formation-position substitute-1">
                                <div class="position-slot" data-position="substitute1" onclick="handlePlayerSlotClick('substitute1')">
                                    <span>بديل</span>
                                </div>
                                <small>بديل أول</small>
                            </div>
                            
                            <div class="formation-position substitute-2">
                                <div class="position-slot" data-position="substitute2" onclick="handlePlayerSlotClick('substitute2')">
                                    <span>بديل</span>
                                </div>
                                <small>بديل ثاني</small>
                            </div>
                        </div>
                        
                        <div class="mt-20" id="transferActionButtons" class="hidden">
                            <button class="btn btn-success" onclick="saveTransfers()">حفظ التبديلات</button>
                            <button class="btn btn-danger" onclick="discardTransfers()">تجاهل التبديلات</button>
                        </div>
                        
                        <div class="mt-20">
                            <h4>اختيار الكابتن:</h4>
                            <select id="captainSelect" class="form-control" onchange="setCaptain()">
                                <option value="">اختر الكابتن</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <h3>معلومات الفريق</h3>
                        <div id="teamInfo">
                            <div class="card" style="background: var(--primary-gradient);">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 2rem; font-weight: bold;" id="totalPoints">0</div>
                                    <div>النقاط الإجمالية</div>
                                </div>
                            </div>
                            <div class="card mt-20" style="background: var(--success-gradient);">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 2rem; font-weight: bold;" id="roundPoints">0</div>
                                    <div>نقاط هذه الجولة</div>
                                </div>
                            </div>
                            <div class="card mt-20" style="background: var(--warning-gradient);">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 2rem; font-weight: bold;" id="teamValue">0</div>
                                    <div>قيمة الفريق (مليون)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم الانتقالات -->
                <!-- هذا القسم سيتم إزالته أو تعديله لاحقاً -->
            </div>

            <!-- المباريات -->
            <div id="matches" class="tab-content">
                <div id="matchesContainer"></div>
            </div>

            <!-- الترتيب -->
            <div id="leaderboard" class="tab-content">
                <div class="grid grid-2">
                    <div class="leaderboard">
                        <div class="leaderboard-header">🏆 ترتيب النقاط الإجمالية</div>
                        <div id="totalLeaderboard"></div>
                    </div>
                    <div class="leaderboard">
                        <div class="leaderboard-header">⚡ ترتيب الجولة الحالية</div>
                        <div id="roundLeaderboard"></div>
                    </div>
                </div>
            </div>

            <!-- إحصائيات اللاعبين -->
            <div id="playerStats" class="tab-content">
                <div class="grid grid-4">
                    <div class="leaderboard">
                        <div class="leaderboard-header">⚽ أكثر اللاعبين تهديفاً</div>
                        <div id="topScorers"></div>
                    </div>
                    <div class="leaderboard">
                        <div class="leaderboard-header">👟 أكثر اللاعبين تمريراً حاسماً</div>
                        <div id="topAssisters"></div>
                    </div>
                    <div class="leaderboard">
                        <div class="leaderboard-header">🟨 أكثر اللاعبين إنذاراً</div>
                        <div id="mostYellowCards"></div>
                    </div>
                    <div class="leaderboard">
                        <div class="leaderboard-header">🟥 أكثر اللاعبين طرداً</div>
                        <div id="mostRedCards"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة دخول الإدارة -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-modal" onclick="closeAdminLogin()">&times;</button>
            <div class="modal-header">
                <h3>🔐 دخول لوحة الإدارة</h3>
            </div>
            <div class="form-group">
                <input type="password" id="adminPassword" class="form-control" placeholder="كلمة مرور الإدارة">
            </div>
            <button onclick="checkAdminPassword()" class="btn btn-primary" style="width: 100%;">دخول</button>
        </div>
    </div>

    <!-- نافذة لوحة الإدارة -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-modal" onclick="closeAdmin()">&times;</button>
            <div class="modal-header">
                <h3>⚙️ لوحة إدارة دوري الفانتازي</h3>
            </div>
            
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('rounds')">📅 الجولات</button>
                <button class="admin-tab" onclick="showAdminTab('matches')">⚽ المباريات</button>
                <button class="admin-tab" onclick="showAdminTab('teams')">🏟️ الفرق</button>
                <button class="admin-tab" onclick="showAdminTab('players')">👨‍🦰 اللاعبين</button>
                <button class="admin-tab" onclick="showAdminTab('users')">👥 المستخدمين</button>
                <button class="admin-tab" onclick="showAdminTab('points')">🎯 إدارة النقاط</button>
            </div>

            <div id="adminRounds" class="admin-content">
                <h4>📅 إدارة الجولات</h4>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>اسم الجولة:</label>
                        <input type="text" id="roundName" class="form-control" placeholder="مثال: الجولة الأولى">
                    </div>
                    <div class="form-group">
                        <label>تاريخ البداية:</label>
                        <input type="datetime-local" id="roundStartDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>تاريخ النهاية:</label>
                        <input type="datetime-local" id="roundEndDate" class="form-control">
                    </div>
                </div>
                <button onclick="createRound()" class="btn btn-success">إضافة جولة جديدة</button>
                <div id="roundsList" class="mt-20"></div>
            </div>

            <div id="adminMatches" class="admin-content hidden">
                <h4>⚽ إدارة المباريات</h4>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>الجولة:</label>
                        <select id="matchRound" class="form-control">
                            <option value="">اختر الجولة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الفريق الأول:</label>
                        <select id="team1" class="form-control">
                            <option value="">اختر الفريق الأول</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الفريق الثاني:</label>
                        <select id="team2" class="form-control">
                            <option value="">اختر الفريق الثاني</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>تاريخ ووقت المباراة:</label>
                        <input type="datetime-local" id="matchDateTime" class="form-control">
                    </div>
                </div>
                <button onclick="createMatch()" class="btn btn-success">إضافة مباراة جديدة</button>
                <div id="adminMatchesList" class="mt-20"></div>
            </div>

            <div id="adminTeams" class="admin-content hidden">
                <h4>🏟️ إدارة الفرق</h4>
                <div class="form-group">
                    <input type="text" id="newTeamName" class="form-control" placeholder="اسم الفريق الجديد">
                </div>
                <button onclick="addTeam()" class="btn btn-success">إضافة فريق</button>
                <div id="teamsList" class="mt-20"></div>
            </div>

            <div id="adminPlayers" class="admin-content hidden">
                <h4>👨‍🦰 إدارة اللاعبين</h4>
                <div class="admin-form-grid">
                    <input type="hidden" id="editPlayerId">
                    <div class="form-group">
                        <input type="text" id="newPlayerName" class="form-control" placeholder="اسم اللاعب">
                    </div>
                    <div class="form-group">
                        <select id="newPlayerTeam" class="form-control">
                            <option value="">اختر الفريق</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select id="newPlayerPosition" class="form-control">
                            <option value="goalkeeper">حارس مرمى</option>
                            <option value="defender">مدافع</option>
                            <option value="midfielder">وسط</option>
                            <option value="forward">مهاجم</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="number" id="newPlayerPrice" class="form-control" placeholder="السعر (بالمليون)" step="0.1">
                    </div>
                </div>
                <button onclick="savePlayer()" class="btn btn-success" id="savePlayerBtn">إضافة لاعب</button>
                <div id="playersAdminList" class="mt-20"></div>
            </div>
            
            <div id="adminUsers" class="admin-content hidden">
                <h4>👥 إدارة المستخدمين</h4>
                <div class="admin-actions">
                    <input type="text" id="deleteUserSearch" class="form-control" placeholder="ابحث عن اسم المستخدم للحذف">
                    <button class="btn btn-danger mt-20" onclick="confirmDeleteUser()">حذف حساب</button>
                </div>
                <div id="usersAdminList" class="mt-20"></div>
            </div>

            <div id="adminPoints" class="admin-content hidden">
                <h4>🎯 إدارة النقاط</h4>
                <div class="grid grid-3">
                    <div class="form-group">
                        <label>اللاعب:</label>
                        <select id="pointsPlayerId" class="form-control">
                            <option value="">اختر اللاعب</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الجولة:</label>
                        <select id="pointsRound" class="form-control">
                            <option value="">اختر الجولة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>النقاط المباشرة:</label>
                        <input type="number" id="directPoints" class="form-control" value="0">
                    </div>
                    <div class="form-group">
                        <label>الأهداف ⚽:</label>
                        <input type="number" id="playerGoals" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>التمريرات الحاسمة 👟:</label>
                        <input type="number" id="playerAssists" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>البطاقات الصفراء 🟨:</label>
                        <input type="number" id="playerYellowCards" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>البطاقات الحمراء 🟥:</label>
                        <input type="number" id="playerRedCards" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group" id="savesMGroup" style="display: none;">
                        <label>التصديات (حراس) 🥅:</label>
                        <input type="number" id="playerSaves" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="playerInjured"> اللاعب مصاب/غائب
                        </label>
                    </div>
                </div>
                <button onclick="updatePlayerPoints()" class="btn btn-success">تحديث النقاط</button>
            </div>
        </div>
    </div>

    <!-- نافذة اختيار اللاعبين -->
    <div id="playerSelectionModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closePlayerSelection()">&times;</button>
            <div class="modal-header">
                <h3>اختيار لاعب</h3>
            </div>
            
            <div class="form-group">
                <input type="text" id="playerSearchInput" class="form-control" placeholder="ابحث عن لاعب..." onkeyup="filterPlayers()">
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" data-position="all" onclick="filterByPosition('all')">الكل</button>
                <button class="btn btn-warning" data-position="goalkeeper" onclick="filterByPosition('goalkeeper')">حراس</button>
                <button class="btn btn-warning" data-position="defender" onclick="filterByPosition('defender')">مدافعين</button>
                <button class="btn btn-warning" data-position="midfielder" onclick="filterByPosition('midfielder')">وسط</button>
                <button class="btn btn-warning" data-position="forward" onclick="filterByPosition('forward')">مهاجمين</button>
            </div>
            
            <div id="availablePlayers" class="grid grid-3"></div>
        </div>
    </div>

    <!-- نافذة إحصائيات المباراة -->
    <div id="matchStatsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeMatchStats()">&times;</button>
            <div class="modal-header">
                <h3 id="matchStatsTitle">إحصائيات المباراة</h3>
            </div>
            <div id="matchStatsContent"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/'; // Your Node.js API base URL (for local development)

        // بيانات اللعبة المحسنة
        let gameData = {
            users: [],
            teams: [
                { id: 1, name: "الأهلي" },
                { id: 2, name: "الزمالك" },
                { id: 3, name: "بيراميدز" },
                { id: 4, name: "المصري" }
            ],
            players: [],
            rounds: [],
            matches: [],
            currentUser: null,
            currentRound: 1,
            maxPlayersPerTeam: 2,
            adminPassword: "admin123",
            stagedTeam: null, // New: for temporary player changes
            stagedBudget: 0,   // New: for temporary budget during transfers
            isTransferMode: false, // New: flag to indicate transfer mode
            // New: power-up pending rounds, these will be set for the next round and activated on round start
            pendingTripleCaptainRound: null,
            pendingBenchBoostRound: null
        };

        // متغير للمركز المحدد حالياً
        let currentSelectionPosition = '';

        // تهيئة البيانات الأولية
        function initializeData() {
            // إضافة لاعبين تجريبيين
            const samplePlayers = [
                // الأهلي
                { id: 1, name: "محمد الشناوي", team: "الأهلي", position: "goalkeeper", price: 3.5, stats: { rounds: {} }, injured: false },
                { id: 2, name: "ياسر إبراهيم", team: "الأهلي", position: "defender", price: 4.2, stats: { rounds: {} }, injured: false },
                { id: 3, name: "أليو ديانغ", team: "الأهلي", position: "midfielder", price: 5.8, stats: { rounds: {} }, injured: false },
                { id: 4, name: "محمد شريف", team: "الأهلي", position: "forward", price: 6.5, stats: { rounds: {} }, injured: false },
                
                // الزمالك
                { id: 5, name: "محمد عواد", team: "الزمالك", position: "goalkeeper", price: 3.2, stats: { rounds: {} }, injured: false },
                { id: 6, name: "حازم إمام", team: "الزمالك", position: "defender", price: 3.8, stats: { rounds: {} }, injured: false },
                { id: 7, name: "إمام عاشور", team: "الزمالك", position: "midfielder", price: 5.5, stats: { rounds: {} }, injured: false },
                { id: 8, name: "سيف الدين الجزيري", team: "الزمالك", position: "forward", price: 5.9, stats: { rounds: {} }, injured: false },
                
                // بيراميدز
                { id: 9, name: "أحمد الشناوي", team: "بيراميدز", position: "goalkeeper", price: 3.0, stats: { rounds: {} }, injured: false },
                { id: 10, name: "أسامة جلال", team: "بيراميدز", position: "defender", price: 3.5, stats: { rounds: {} }, injured: false },
                { id: 11, name: "رمضان صبحي", team: "بيراميدز", position: "midfielder", price: 6.2, stats: { rounds: {} }, injured: false },
                { id: 12, name: "فخر الدين بن يوسف", team: "بيراميدز", position: "forward", price: 5.7, stats: { rounds: {} }, injured: false },
                
                // المصري
                { id: 13, name: "محمد صبحي", team: "المصري", position: "goalkeeper", price: 2.8, stats: { rounds: {} }, injured: false },
                { id: 14, name: "أحمد توفيق", team: "المصري", position: "defender", price: 3.2, stats: { rounds: {} }, injured: false },
                { id: 15, name: "مروان حمدي", team: "المصري", position: "midfielder", price: 4.8, stats: { rounds: {} }, injured: false },
                { id: 16, name: "عمرو مرعي", team: "المصري", position: "forward", price: 4.5, stats: { rounds: {} }, injured: false }
            ];

            // تحميل البيانات المحفوظة أو استخدام البيانات الافتراضية
            const savedData = localStorage.getItem('fantasyLeagueData');
            if (savedData) {
                gameData = { ...gameData, ...JSON.parse(savedData) };
            } else {
                gameData.players = samplePlayers;
                // إضافة جولة افتراضية
                gameData.rounds = [{
                    id: 1,
                    name: "الجولة الأولى",
                    startDate: new Date().toISOString(),
                    endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                }];
                saveGameData();
            }

            // تحقق من تسجيل الدخول
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                gameData.currentUser = JSON.parse(currentUser);
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        // حفظ البيانات
        function saveGameData() {
            localStorage.setItem('fantasyLeagueData', JSON.stringify(gameData));
        }

        // تسجيل الدخول
        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                alert('يرجى إدخال اسم المستخدم وكلمة المرور');
                return;
            }

            const user = gameData.users.find(u => u.username === username && u.password === password);
            if (user) {
                gameData.currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                alert('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        // تسجيل حساب جديد
        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const teamName = document.getElementById('regTeamName').value.trim();

            if (!username || !password || !teamName) {
                alert('يرجى ملء جميع الحقول');
                return;
            }

            if (gameData.users.find(u => u.username === username)) {
                alert('اسم المستخدم موجود بالفعل');
                return;
            }

            const newUser = {
                id: Date.now(),
                username,
                password,
                teamName,
                team: {
                    goalkeeper: null,
                    defender: null,
                    midfielder1: null,
                    midfielder2: null,
                    forward: null,
                    substitute1: null,
                    substitute2: null,
                    captain: null,
                    tripleCaptain: null, // جديد
                    tripleCaptainUsed: false,
                    benchBoostUsed: false,
                    benchBoostRound: null,
                    freeTransfers: 0 // New property for free transfers
                },
                budget: 45,
                totalPoints: 0,
                roundPoints: {},
                transfersRemaining: 2,
                freeTransfers: 0, // New property for free transfers
                powerUps: {
                    tripleCaptainUsed: false,
                    benchBoostUsed: false,
                    pendingTripleCaptainRound: null, // New: for next round's triple captain
                    pendingBenchBoostRound: null    // New: for next round's bench boost
                }
            };

            gameData.users.push(newUser);
            gameData.currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            saveGameData();
            showMainApp();
        }

        // عرض شاشة التسجيل
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        // عرض شاشة تسجيل الدخول
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // تسجيل الخروج
        function logout() {
            localStorage.removeItem('currentUser');
            gameData.currentUser = null;
            showLoginScreen();
        }

        // عرض شاشة تسجيل الدخول
        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // عرض التطبيق الرئيسي
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('currentUser').textContent = gameData.currentUser.username;
            document.getElementById('currentTeam').textContent = gameData.currentUser.teamName;
            
            updateUI();
        }

        // تبديل التبويبات
        function showTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إزالة التفعيل من جميع أزرار التبويبات
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار التبويب المحدد
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // تحديث محتوى التبويب
            if (tabName === 'matches') {
                updateMatchesDisplay();
            } else if (tabName === 'leaderboard') {
                updateLeaderboards();
            } else if (tabName === 'playerStats') {
                updatePlayerStats();
            } else if (tabName === 'teamFormation') {
                // updateTransferOptions(); // Removed as transfer logic is now integrated
            }
        }

        // استخدام التريبل كابتن
        function useTripleCaptain() {
            if (isGameweekActive()) {
                alert('لا يمكن تفعيل التريبل كابتن أثناء الجولة الجارية! يمكن تفعيله قبل بدء الجولة التالية.');
                return;
            }
            if (gameData.currentUser.powerUps.tripleCaptainUsed) {
                alert('لقد استخدمت التريبل كابتن من قبل!');
                return;
            }
            if (gameData.currentUser.powerUps.pendingTripleCaptainRound === gameData.currentRound + 1) {
                alert('لقد قمت بالفعل بتفعيل التريبل كابتن للجولة القادمة!');
                return;
            }
            if (gameData.currentUser.powerUps.benchBoostUsed || gameData.currentUser.powerUps.pendingBenchBoostRound === gameData.currentRound + 1) {
                alert('لا يمكن تفعيل التريبل كابتن والبينش بوست في نفس الجولة!');
                return;
            }

            if (!gameData.currentUser.team.captain) {
                alert('يجب اختيار كابتن أولاً!');
                return;
            }

            const nextRoundId = gameData.currentRound + 1;
            const nextRound = gameData.rounds.find(r => r.id === nextRoundId);

            if (!nextRound) {
                alert('لا توجد جولة قادمة لتفعيل التريبل كابتن فيها.');
                return;
            }

            if (confirm(`هل أنت متأكد من تفعيل التريبل كابتن للجولة ${nextRound.name}؟ لن يمكنك استخدامه مرة أخرى!`)) {
                gameData.currentUser.powerUps.pendingTripleCaptainRound = nextRoundId;
                // Don't set tripleCaptain yet, it will be set when the round starts
                // gameData.currentUser.team.tripleCaptain = gameData.currentUser.team.captain;
                // gameData.currentUser.team.tripleCaptainRound = gameData.currentRound;
                
                updateUserData();
                updatePowerUpsDisplay();
                alert(`تم تفعيل التريبل كابتن للجولة ${nextRound.name}! سيحصل الكابتن على 3 أضعاف النقاط في تلك الجولة.`);
            }
        }

        // استخدام البينش بوست
        function useBenchBoost() {
            if (isGameweekActive()) {
                alert('لا يمكن تفعيل البينش بوست أثناء الجولة الجارية! يمكن تفعيله قبل بدء الجولة التالية.');
                return;
            }
            if (gameData.currentUser.powerUps.benchBoostUsed) {
                alert('لقد استخدمت البينش بوست من قبل!');
                return;
            }
            if (gameData.currentUser.powerUps.pendingBenchBoostRound === gameData.currentRound + 1) {
                alert('لقد قمت بالفعل بتفعيل البينش بوست للجولة القادمة!');
                return;
            }
            if (gameData.currentUser.powerUps.tripleCaptainUsed || gameData.currentUser.powerUps.pendingTripleCaptainRound === gameData.currentRound + 1) {
                alert('لا يمكن تفعيل التريبل كابتن والبينش بوست في نفس الجولة!');
                return;
            }

            const nextRoundId = gameData.currentRound + 1;
            const nextRound = gameData.rounds.find(r => r.id === nextRoundId);

            if (!nextRound) {
                alert('لا توجد جولة قادمة لتفعيل البينش بوست فيها.');
                return;
            }

            if (confirm(`هل أنت متأكد من تفعيل البينش بوست للجولة ${nextRound.name}؟ لن يمكنك استخدامه مرة أخرى!`)) {
                gameData.currentUser.powerUps.pendingBenchBoostRound = nextRoundId;
                // Don't set benchBoostUsed or benchBoostRound yet, it will be set when the round starts
                // gameData.currentUser.powerUps.benchBoostUsed = true;
                // gameData.currentUser.team.benchBoostRound = gameData.currentRound;
                
                updateUserData();
                updatePowerUpsDisplay();
                alert(`تم تفعيل البينش بوست للجولة ${nextRound.name}! ستحصل على نقاط جميع اللاعبين البدلاء في تلك الجولة.`);
            }
        }

        // تحديث عرض البطاقات الخاصة
        function updatePowerUpsDisplay() {
            const tripleCaptainCard = document.getElementById('tripleCaptainCard');
            const benchBoostCard = document.getElementById('benchBoostCard');
            const tripleCaptainBtn = document.getElementById('tripleCaptainBtn');
            const benchBoostBtn = document.getElementById('benchBoostBtn');
            const tripleCaptainSpan = tripleCaptainCard.querySelector('span');
            const benchBoostSpan = benchBoostCard.querySelector('span');

            // Reset state
            tripleCaptainCard.classList.remove('power-up-used', 'power-up-pending');
            benchBoostCard.classList.remove('power-up-used', 'power-up-pending');
            tripleCaptainBtn.style.display = 'inline-flex';
            benchBoostBtn.style.display = 'inline-flex';
            tripleCaptainSpan.textContent = '👑 التريبل كابتن (نقاط × 3)';
            benchBoostSpan.textContent = '🚀 البينش بوست (نقاط البدلاء)';

            // Triple Captain Logic
            if (gameData.currentUser.powerUps.tripleCaptainUsed) {
                tripleCaptainCard.classList.add('power-up-used');
                tripleCaptainBtn.style.display = 'none';
                tripleCaptainSpan.textContent = '👑 التريبل كابتن (تم الاستخدام)';
            } else if (gameData.currentUser.powerUps.pendingTripleCaptainRound) {
                const nextRound = gameData.rounds.find(r => r.id === gameData.currentUser.powerUps.pendingTripleCaptainRound);
                if (nextRound) {
                    tripleCaptainCard.classList.add('power-up-pending');
                    tripleCaptainBtn.style.display = 'none';
                    tripleCaptainSpan.textContent = `👑 التريبل كابتن (مفعل للجولة ${nextRound.name})`;
                }
            }

            // Bench Boost Logic
            if (gameData.currentUser.powerUps.benchBoostUsed) {
                benchBoostCard.classList.add('power-up-used');
                benchBoostBtn.style.display = 'none';
                benchBoostSpan.textContent = '🚀 البينش بوست (تم الاستخدام)';
            } else if (gameData.currentUser.powerUps.pendingBenchBoostRound) {
                const nextRound = gameData.rounds.find(r => r.id === gameData.currentUser.powerUps.pendingBenchBoostRound);
                if (nextRound) {
                    benchBoostCard.classList.add('power-up-pending');
                    benchBoostBtn.style.display = 'none';
                    benchBoostSpan.textContent = `🚀 البينش بوست (مفعل للجولة ${nextRound.name})`;
                }
            }

            // Disable buttons if any power-up is active or pending
            if (gameData.currentUser.powerUps.tripleCaptainUsed || gameData.currentUser.powerUps.pendingTripleCaptainRound ||
                gameData.currentUser.powerUps.benchBoostUsed || gameData.currentUser.powerUps.pendingBenchBoostRound) {
                tripleCaptainBtn.disabled = true;
                benchBoostBtn.disabled = true;
            } else {
                tripleCaptainBtn.disabled = false;
                benchBoostBtn.disabled = false;
            }
        }

        // تحديث بيانات المستخدم
        function updateUserData() {
            const userIndex = gameData.users.findIndex(u => u.id === gameData.currentUser.id);
            if (userIndex !== -1) {
                gameData.users[userIndex] = gameData.currentUser;
            }
            saveGameData();
            localStorage.setItem('currentUser', JSON.stringify(gameData.currentUser));
        }

        // باقي الوظائف ستكون في الجزء الثاني...
        // [تكملة الكود في الرد التالي]

        // فتح نافذة دخول الإدارة
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('active');
        }

        // إغلاق نافذة دخول الإدارة
        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('active');
            document.getElementById('adminPassword').value = '';
        }

        // التحقق من كلمة مرور الإدارة
        function checkAdminPassword() {
            const password = document.getElementById('adminPassword').value;
            if (password === gameData.adminPassword) {
                closeAdminLogin();
                document.getElementById('adminModal').classList.add('active');
                updateAdminData(); // تحديث بيانات لوحة الإدارة عند الدخول
            } else {
                alert('كلمة مرور الإدارة غير صحيحة.');
            }
        }

        // Add event listener for Enter key on admin password input
        document.addEventListener('DOMContentLoaded', () => {
            const adminPasswordInput = document.getElementById('adminPassword');
            if (adminPasswordInput) {
                adminPasswordInput.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Prevent default form submission
                        checkAdminPassword();
                    }
                });
            }
        });

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('active');
        }

        // عرض لوحة الإدارة (هذه الدالة لم تعد مستخدمة بعد التغييرات الأخيرة)
        // function showAdmin() {
        //     document.getElementById('adminModal').classList.add('active');
        //     updateAdminData(); // تحديث بيانات لوحة الإدارة عند الدخول
        // }

        // إغلاق لوحة الإدارة
        function closeAdmin() {
            document.getElementById('adminModal').classList.remove('active');
        }

        // تبديل تبويبات الإدارة
        function showAdminTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // إزالة التفعيل من جميع الأزرار
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المحدد
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            event.target.classList.add('active');
            
            // تحديث البيانات حسب التبويب
            if (tabName === 'matches') {
                updateAdminMatchesList();
                updateMatchRoundOptions();
            } else if (tabName === 'players') {
                updatePlayerTeamOptions();
            } else if (tabName === 'users') {
                updateUsersList();
            } else if (tabName === 'points') {
                updatePlayerPointsOptions();
                updatePointsRoundOptions();
            }
        }

        // تحديث بيانات الإدارة
        function updateAdminData() {
            updateRoundsList();
            updateTeamsList();
            updateTeamOptions();
            updatePlayersAdminList(); // Add this line to update players list
            updateUsersList(); // Add this line to update users list
        }

        // إنشاء جولة جديدة
        function createRound() {
            const name = document.getElementById('roundName').value.trim();
            const startDate = document.getElementById('roundStartDate').value;
            const endDate = document.getElementById('roundEndDate').value;

            if (!name || !startDate || !endDate) {
                alert('يرجى ملء جميع الحقول');
                return;
            }

            const newRound = {
                id: Date.now(),
                name,
                startDate,
                endDate
            };

            gameData.rounds.push(newRound);
            gameData.currentRound = newRound.id;
            
            // Activate pending power-ups for all users for the new current round
            gameData.users.forEach(user => {
                // Activate Triple Captain if pending for this round
                if (user.powerUps.pendingTripleCaptainRound === newRound.id) {
                    user.powerUps.tripleCaptainUsed = true;
                    user.team.tripleCaptain = user.team.captain;
                    user.team.tripleCaptainRound = newRound.id;
                    user.powerUps.pendingTripleCaptainRound = null; // Clear pending status
                }
                // Activate Bench Boost if pending for this round
                if (user.powerUps.pendingBenchBoostRound === newRound.id) {
                    user.powerUps.benchBoostUsed = true;
                    user.team.benchBoostRound = newRound.id;
                    user.powerUps.pendingBenchBoostRound = null; // Clear pending status
                }
                user.transfersRemaining = 2;
            });
            
            // مسح الحقول
            document.getElementById('roundName').value = '';
            document.getElementById('roundStartDate').value = '';
            document.getElementById('roundEndDate').value = '';
            
            saveGameData();
            updateRoundsList();
            alert('تم إنشاء الجولة بنجاح');
        }

        // تحديث قائمة الجولات
        function updateRoundsList() {
            const container = document.getElementById('roundsList');
            container.innerHTML = '';
            
            gameData.rounds.forEach(round => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'card';
                roundDiv.innerHTML = `
                    <h5>${round.name}</h5>
                    <p>البداية: ${new Date(round.startDate).toLocaleDateString('ar-EG')}</p>
                    <p>النهاية: ${new Date(round.endDate).toLocaleDateString('ar-EG')}</p>
                    <button onclick="deleteRound(${round.id})" class="btn btn-danger">حذف</button>
                `;
                container.appendChild(roundDiv);
            });
        }

        function deleteRound(roundId) {
            if (confirm('هل أنت متأكد من حذف هذه الجولة؟ سيتم حذف جميع المباريات المرتبطة بها أيضاً.')) {
                gameData.rounds = gameData.rounds.filter(round => round.id !== roundId);
                gameData.matches = gameData.matches.filter(match => match.roundId !== roundId); // حذف المباريات المرتبطة بالجولة
                saveGameData();
                updateRoundsList();
                updateMatchRoundOptions(); // Refresh match round options
                updatePointsRoundOptions(); // Refresh points round options
                alert('تم حذف الجولة بنجاح');
            }
        }

        // إنشاء مباراة جديدة
        function createMatch() {
            const roundId = document.getElementById('matchRound').value;
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            const dateTime = document.getElementById('matchDateTime').value;

            if (!roundId || !team1 || !team2 || !dateTime) {
                alert('يرجى ملء جميع الحقول');
                return;
            }

            if (team1 === team2) {
                alert('لا يمكن أن يلعب الفريق ضد نفسه!');
                return;
            }

            const newMatch = {
                id: Date.now(),
                roundId: parseInt(roundId),
                team1,
                team2,
                dateTime,
                status: 'upcoming',
                score: { team1: null, team2: null },
                stats: {
                    team1: { goals: [], assists: [], yellowCards: [], redCards: [] },
                    team2: { goals: [], assists: [], yellowCards: [], redCards: [] }
                }
            };

            gameData.matches.push(newMatch);
            
            // مسح الحقول
            document.getElementById('matchRound').value = '';
            document.getElementById('team1').value = '';
            document.getElementById('team2').value = '';
            document.getElementById('matchDateTime').value = '';
            
            saveGameData();
            updateAdminMatchesList();
            alert('تم إنشاء المباراة بنجاح');
        }

        // تحديث خيارات الجولات للمباريات
        function updateMatchRoundOptions() {
            const select = document.getElementById('matchRound');
            select.innerHTML = '<option value="">اختر الجولة</option>';
            
            gameData.rounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round.id;
                option.textContent = round.name;
                select.appendChild(option);
            });
        }

        // تحديث خيارات الفرق
        function updateTeamOptions() {
            const selects = ['team1', 'team2'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">اختر الفريق</option>';
                    
                    gameData.teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.name;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // باقي الوظائف في التكملة...
        // تحديث عرض المباريات
        function updateMatchesDisplay() {
            const container = document.getElementById('matchesContainer');
            container.innerHTML = '';

            if (gameData.rounds.length === 0) {
                container.innerHTML = '<div class="card text-center"><h3>لا توجد جولات حالياً</h3></div>';
                return;
            }

            gameData.rounds.forEach(round => {
                const roundMatches = gameData.matches.filter(match => match.roundId === round.id);
                
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round-section';
                
                roundDiv.innerHTML = `
                    <div class="round-header">${round.name}</div>
                    <div id="round-${round.id}-matches"></div>
                `;
                
                container.appendChild(roundDiv);
                
                const matchesContainer = document.getElementById(`round-${round.id}-matches`);
                
                if (roundMatches.length === 0) {
                    matchesContainer.innerHTML = '<div class="card text-center">لا توجد مباريات في هذه الجولة</div>';
                } else {
                    roundMatches.forEach(match => {
                        const matchCard = document.createElement('div');
                        matchCard.className = 'match-card';
                        matchCard.onclick = () => showMatchStats(match);
                        
                        const matchDate = new Date(match.dateTime);
                        const now = new Date();
                        const isFinished = now > matchDate;
                        
                        matchCard.innerHTML = `
                            <div class="match-teams">
                                <div style="font-weight: bold;">${match.team1}</div>
                                <div class="match-score">
                                    ${match.score.team1 !== null ? `${match.score.team1} - ${match.score.team2}` : 'VS'}
                                </div>
                                <div style="font-weight: bold;">${match.team2}</div>
                            </div>
                            <div class="match-info">
                                ${matchDate.toLocaleDateString('ar-EG')} - ${matchDate.toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'})}
                                <span class="match-status ${isFinished ? 'finished' : 'upcoming'}">
                                    ${isFinished ? 'انتهت' : 'قادمة'}
                                </span>
                            </div>
                        `;
                        
                        matchesContainer.appendChild(matchCard);
                    });
                }
            });
        }

        // إظهار إحصائيات المباراة
        function showMatchStats(match) {
            const modal = document.getElementById('matchStatsModal');
            const title = document.getElementById('matchStatsTitle');
            const content = document.getElementById('matchStatsContent');
            
            title.textContent = `${match.team1} VS ${match.team2}`;
            
            const matchDate = new Date(match.dateTime);
            const now = new Date();
            const isFinished = now > matchDate;
            
            if (!isFinished) {
                content.innerHTML = `
                    <div class="card text-center">
                        <h4>المباراة لم تبدأ بعد</h4>
                        <p>موعد المباراة: ${matchDate.toLocaleDateString('ar-EG')} - ${matchDate.toLocaleTimeString('ar-EG')}</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="grid grid-2">
                        <div class="card">
                            <h4>${match.team1}</h4>
                            <div class="mb-20">
                                <strong>الأهداف ⚽:</strong>
                                ${match.stats.team1.goals.map(goal => `<div>${goal.player} (${goal.minute}')</div>`).join('') || 'لا توجد أهداف'}
                            </div>
                            <div class="mb-20">
                                <strong>التمريرات الحاسمة 👟:</strong>
                                ${match.stats.team1.assists.map(assist => `<div>${assist.player} (${assist.minute}')</div>`).join('') || 'لا توجد تمريرات حاسمة'}
                            </div>
                            <div class="mb-20">
                                <strong>البطاقات الصفراء 🟨:</strong>
                                ${match.stats.team1.yellowCards.map(card => `<div>${card.player} (${card.minute}')</div>`).join('') || 'لا توجد بطاقات صفراء'}
                            </div>
                            <div>
                                <strong>البطاقات الحمراء 🟥:</strong>
                                ${match.stats.team1.redCards.map(card => `<div>${card.player} (${card.minute}')</div>`).join('') || 'لا توجد بطاقات حمراء'}
                            </div>
                        </div>
                        <div class="card">
                            <h4>${match.team2}</h4>
                            <div class="mb-20">
                                <strong>الأهداف ⚽:</strong>
                                ${match.stats.team2.goals.map(goal => `<div>${goal.player} (${goal.minute}')</div>`).join('') || 'لا توجد أهداف'}
                            </div>
                            <div class="mb-20">
                                <strong>التمريرات الحاسمة 👟:</strong>
                                ${match.stats.team2.assists.map(assist => `<div>${assist.player} (${assist.minute}')</div>`).join('') || 'لا توجد تمريرات حاسمة'}
                            </div>
                            <div class="mb-20">
                                <strong>البطاقات الصفراء 🟨:</strong>
                                ${match.stats.team2.yellowCards.map(card => `<div>${card.player} (${card.minute}')</div>`).join('') || 'لا توجد بطاقات صفراء'}
                            </div>
                            <div>
                                <strong>البطاقات الحمراء 🟥:</strong>
                                ${match.stats.team2.redCards.map(card => `<div>${card.player} (${card.minute}')</div>`).join('') || 'لا توجد بطاقات حمراء'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }

        // إغلاق إحصائيات المباراة
        function closeMatchStats() {
            document.getElementById('matchStatsModal').classList.remove('active');
        }

        // فتح نافذة اختيار اللاعبين
        async function openPlayerSelection(slotKey, forceOpen = false) {
            if (!gameData.isTransferMode && !forceOpen) {
                alert('لإجراء تغييرات على اللاعبين، يرجى الدخول إلى وضع إدارة الانتقالات أولاً.');
                return;
            }
            if (await isGameweekActive()) {
                alert('لا يمكن تغيير اللاعبين أثناء الجولة الجارية!');
                return;
            }
            currentSelectionPosition = slotKey;
            let filterPosition = '';

            if (slotKey.includes('goalkeeper')) filterPosition = 'goalkeeper';
            else if (slotKey.includes('defender')) filterPosition = 'defender';
            else if (slotKey.includes('midfielder')) filterPosition = 'midfielder';
            else if (slotKey.includes('forward')) filterPosition = 'forward';
            else if (slotKey.includes('substitute')) filterPosition = 'all'; // Substitutes can be any position
            
            document.getElementById('playerSelectionModal').classList.add('active');
            await displayAvailablePlayers(filterPosition);
        }

        // إغلاق نافذة اختيار اللاعبين
        function closePlayerSelection() {
            document.getElementById('playerSelectionModal').classList.remove('active');
        }

        // عرض اللاعبين المتاحين
        function displayAvailablePlayers(filterPositionParam) {
            const container = document.getElementById('availablePlayers');
            container.innerHTML = '';
            
            let filteredPlayers = gameData.players.filter(player => {
                // Use filterPosition here
                if (filterPositionParam !== 'all' && player.position !== filterPositionParam) {
                    return false;
                }
                
                // Determine which team to check against (staged or current) and which budget to use
                const teamToCheck = gameData.isTransferMode ? gameData.stagedTeam : gameData.currentUser.team;
                const budgetToCheck = gameData.isTransferMode ? gameData.stagedBudget : gameData.currentUser.budget;

                // تحقق من أن اللاعب ليس في الفريق بالفعل (باستخدام الفريق المناسب)
                const isInTeam = Object.values(teamToCheck).some(selectedPlayer => 
                    selectedPlayer && selectedPlayer.id === player.id
                );
                
                if (isInTeam) return false;
                
                // تحقق من أن المستخدم لا يملك أكثر من لاعبين من نفس الفريق (باستخدام الفريق المناسب)
                const teamPlayersCount = Object.values(teamToCheck).filter(selectedPlayer => 
                    selectedPlayer && selectedPlayer.team === player.team
                ).length;
                
                if (teamPlayersCount >= gameData.maxPlayersPerTeam) return false;
                
                // تحقق من الميزانية (باستخدام الميزانية المناسبة)
                if (player.price > budgetToCheck) return false;
                
                return true;
            });
            
            // تطبيق فلتر البحث
            const searchTerm = document.getElementById('playerSearchInput').value.toLowerCase();
            if (searchTerm) {
                filteredPlayers = filteredPlayers.filter(player => 
                    player.name.toLowerCase().includes(searchTerm) ||
                    player.team.toLowerCase().includes(searchTerm)
                );
            }
            
            filteredPlayers.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                playerCard.onclick = () => selectPlayer(player);
                
                // حساب الإحصائيات الإجمالية
                const totalGoals = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.goals || 0), 0);
                const totalAssists = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.assists || 0), 0);
                const totalYellowCards = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.yellowCards || 0), 0);
                const totalRedCards = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.redCards || 0), 0);
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="player-team">${player.team}</div>
                    <div class="player-price">${player.price} مليون</div>
                    <div class="player-stats">
                        <span class="stat-item">⚽ ${totalGoals}</span>
                        <span class="stat-item">👟 ${totalAssists}</span>
                        <span class="stat-item">🟨 ${totalYellowCards}</span>
                        <span class="stat-item">🟥 ${totalRedCards}</span>
                    </div>
                `;
                
                container.appendChild(playerCard);
            });
        }

        // اختيار لاعب
        function selectPlayer(player) {
            if (gameData.isTransferMode) {
                gameData.stagedTeam[currentSelectionPosition] = { ...player };
                gameData.stagedBudget -= player.price;
            } else {
            gameData.currentUser.team[currentSelectionPosition] = { ...player };
            gameData.currentUser.budget -= player.price;
            }
            
            // Only update user data immediately if not in transfer mode. Otherwise, it will be updated by saveTransfers().
            if (!gameData.isTransferMode) {
            updateUserData();
            }
            closePlayerSelection();
            updateUI();
        }

        // فلترة اللاعبين
        function filterPlayers() {
            // Re-call displayAvailablePlayers with the current filter position, which is now derived from currentSelectionPosition
            let filterPosition = '';
            if (currentSelectionPosition.includes('goalkeeper')) filterPosition = 'goalkeeper';
            else if (currentSelectionPosition.includes('defender')) filterPosition = 'defender';
            else if (currentSelectionPosition.includes('midfielder')) filterPosition = 'midfielder';
            else if (currentSelectionPosition.includes('forward')) filterPosition = 'forward';
            else if (currentSelectionPosition.includes('substitute')) filterPosition = 'all';
            
            displayAvailablePlayers(filterPosition);
        }

        // فلترة حسب المركز
        function filterByPosition(position) {
            // When filtering by position in the modal, we need to apply the filter, but keep the original slotKey for selection
            let actualFilterPosition = position;
            if (position === 'all') {
                // If 'all' is selected, and we are in a substitute slot, keep 'all' for filtering
                if (currentSelectionPosition.includes('substitute')) {
                    actualFilterPosition = 'all';
                } else {
                    // If 'all' is selected for a main slot, effectively remove position filtering
                    actualFilterPosition = ''; // No position filter
                }
            }
            displayAvailablePlayers(actualFilterPosition);
        }

        // تحديد الكابتن
        function setCaptain() {
            if (isGameweekActive()) {
                alert('لا يمكن تغيير الكابتن أثناء الجولة الجارية!');
                // Reset the select box to the current captain if there is one
                const currentCaptainId = gameData.currentUser.team.captain;
                document.getElementById('captainSelect').value = currentCaptainId || '';
                return;
            }
            const captainSelect = document.getElementById('captainSelect');
            const selectedPlayerId = parseInt(captainSelect.value);
            
            if (selectedPlayerId) {
                gameData.currentUser.team.captain = selectedPlayerId;
                updateUserData();
                updateFormationDisplay();
            }
        }

        // تحديث الواجهة
        function updateUI() {
            calculateRemainingBudget(); // Ensure budget is calculated before display
            updateBudgetDisplay();
            updateFormationDisplay();
            updateCaptainOptions();
            updateTeamStats();
            updatePowerUpsDisplay();
        }

        // حساب الميزانية المتبقية بناءً على قيمة الفريق
        function calculateRemainingBudget() {
            let teamValue = 0;
            const teamToCalculate = gameData.isTransferMode ? gameData.stagedTeam : gameData.currentUser.team;
            
            Object.keys(teamToCalculate).forEach(position => {
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound', 'freeTransfers'].includes(position)) return;
                if (teamToCalculate[position]) {
                    teamValue += teamToCalculate[position].price;
                }
            });
            
            if (gameData.isTransferMode) {
                gameData.stagedBudget = 45 - teamValue;
            } else {
                gameData.currentUser.budget = 45 - teamValue;
            }
        }

        // تحديث عرض الميزانية
        function updateBudgetDisplay() {
            const budgetToDisplay = gameData.isTransferMode ? gameData.stagedBudget : gameData.currentUser.budget;
            document.getElementById('remainingBudget').textContent = 
                budgetToDisplay.toFixed(1);
        }

        // تحديث عرض التشكيلة
        function updateFormationDisplay() {
            const currentTeam = gameData.currentUser.team;
            const teamToDisplay = gameData.isTransferMode ? gameData.stagedTeam : currentTeam;
            
            Object.keys(teamToDisplay).forEach(position => {
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound'].includes(position)) return;
                
                const slot = document.querySelector(`[data-position="${position}"]`);
                if (slot) {
                    // Reset classes
                    slot.classList.remove('filled', 'triple-captain', 'player-removed', 'player-added');

                    const playerInDisplay = teamToDisplay[position];
                    const playerInCurrent = currentTeam[position];

                    if (playerInDisplay) {
                        slot.innerHTML = ''; // Clear existing content before filling with player data
                        slot.classList.add('filled');
                        
                        // Check for Triple Captain
                        if (teamToDisplay.tripleCaptain === playerInDisplay.id && teamToDisplay.tripleCaptainRound === gameData.currentRound) {
                            slot.classList.add('triple-captain');
                        }

                        // Visual indication for transfers
                        if (gameData.isTransferMode) {
                            if (!playerInCurrent) {
                                slot.classList.add('player-added');
                            } else if (playerInCurrent.id !== playerInDisplay.id) {
                                // This case means a player was swapped, so it's both removed and added.
                                // We'll prioritize 'added' visual if a new player is in the slot.
                                // Or we could add a 'player-swapped' class if needed.
                                slot.classList.add('player-added');
                            }
                        }
                        
                        slot.innerHTML = `
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; font-weight: bold;">${playerInDisplay.name}</div>
                                <div style="font-size: 0.7rem;">${playerInDisplay.team}</div>
                                ${teamToDisplay.captain === playerInDisplay.id ? '<div style="color: #ffd700;">👑</div>' : ''}
                                ${teamToDisplay.tripleCaptain === playerInDisplay.id && teamToDisplay.tripleCaptainRound === gameData.currentRound ? '<div style="color: #ffd700;">👑👑👑</div>' : ''}
                            </div>
                        `;
                    } else {
                        // Slot is empty
                        slot.innerHTML = ''; // Clear existing content first
                        if (gameData.isTransferMode && playerInCurrent) {
                            slot.classList.add('player-removed'); // Visually indicate player was removed
                        }
                        const positionNames = {
                            goalkeeper: 'حارس',
                            defender: 'مدافع',
                            midfielder1: 'وسط',
                            midfielder2: 'وسط',
                            forward: 'مهاجم',
                            substitute1: 'بديل',
                            substitute2: 'بديل'
                        };
                        slot.innerHTML += `<span>${positionNames[position]}</span>`; // Add only the relevant span
                    }
                }
            });
        }

        // تحديث خيارات الكابتن
        function updateCaptainOptions() {
            const captainSelect = document.getElementById('captainSelect');
            captainSelect.innerHTML = '<option value="">اختر الكابتن</option>';
            
            const team = gameData.currentUser.team;
            Object.keys(team).forEach(position => {
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound'].includes(position) || !team[position]) return;
                
                const option = document.createElement('option');
                option.value = team[position].id;
                option.textContent = `${team[position].name} (${team[position].team})`;
                
                if (team.captain === team[position].id) {
                    option.selected = true;
                }
                
                captainSelect.appendChild(option);
            });
        }

        // تحديث إحصائيات الفريق
        function updateTeamStats() {
            let totalPoints = 0;
            let roundPoints = 0;
            let teamValue = 0;
            
            const team = gameData.currentUser.team;
            Object.keys(team).forEach(position => {
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound'].includes(position) || !team[position]) return;
                
                const player = team[position];
                teamValue += player.price;
                
                // حساب النقاط لجميع الجولات
                Object.values(player.stats.rounds).forEach(roundStats => {
                    let playerPoints = (roundStats.goals || 0) * 4 + (roundStats.assists || 0) * 3 - (roundStats.yellowCards || 0) * 1 - (roundStats.redCards || 0) * 3;
                    
                    // إضافة نقاط التصديات للحراس
                    if (player.position === 'goalkeeper') {
                        playerPoints += (roundStats.saves || 0) * 1;
                    }
                    
                    totalPoints += Math.max(0, playerPoints);
                });
                
                // حساب نقاط الجولة الحالية
                const currentRoundStats = player.stats.rounds[gameData.currentRound] || {};
                let currentPlayerPoints = (currentRoundStats.goals || 0) * 4 + (currentRoundStats.assists || 0) * 3 - (currentRoundStats.yellowCards || 0) * 1 - (currentRoundStats.redCards || 0) * 3;
                
                if (player.position === 'goalkeeper') {
                    currentPlayerPoints += (currentRoundStats.saves || 0) * 1;
                }
                
                // تطبيق ضاعف الكابتن أو التريبل كابتن
                if (team.captain === player.id) {
                    if (team.tripleCaptain === player.id && team.tripleCaptainRound === gameData.currentRound) {
                        currentPlayerPoints *= 3; // التريبل كابتن
                    } else {
                        currentPlayerPoints *= 2; // الكابتن العادي
                    }
                }
                
                roundPoints += Math.max(0, currentPlayerPoints);
            });
            
            // إضافة نقاط البدلاء إذا تم استخدام البينش بوست
            if (team.benchBoostRound === gameData.currentRound) {
                ['substitute1', 'substitute2'].forEach(position => {
                    if (team[position]) {
                        const player = team[position];
                        const currentRoundStats = player.stats.rounds[gameData.currentRound] || {};
                        let benchPlayerPoints = (currentRoundStats.goals || 0) * 4 + (currentRoundStats.assists || 0) * 3 - (currentRoundStats.yellowCards || 0) * 1 - (currentRoundStats.redCards || 0) * 3;
                        
                        if (player.position === 'goalkeeper') {
                            benchPlayerPoints += (currentRoundStats.saves || 0) * 1;
                        }
                        
                        roundPoints += Math.max(0, benchPlayerPoints);
                    }
                });
            }
            
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('roundPoints').textContent = roundPoints;
            document.getElementById('teamValue').textContent = teamValue.toFixed(1);
            
            // تحديث نقاط المستخدم
            gameData.currentUser.totalPoints = totalPoints;
            if (!gameData.currentUser.roundPoints) {
                gameData.currentUser.roundPoints = {};
            }
            gameData.currentUser.roundPoints[gameData.currentRound] = roundPoints;
            
            updateUserData();
        }

        // باقي الوظائف (الانتقالات، اللوحات، الإدارة...)
        // [الكود سيكمل في ردود تالية بسبب الحد الأقصى للأحرف]

        // تحديث خيارات الانتقالات
        function updateTransferOptions() {
            document.getElementById('remainingTransfers').textContent = gameData.currentUser.transfersRemaining;
            
            // خيارات البيع
            const sellSelect = document.getElementById('sellPlayer');
            sellSelect.innerHTML = '<option value="">اختر لاعب للبيع</option>';
            
            const team = gameData.currentUser.team;
            Object.keys(team).forEach(position => {
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound'].includes(position) || !team[position]) return;
                
                const option = document.createElement('option');
                option.value = position;
                option.textContent = `${team[position].name} (${team[position].team}) - ${team[position].price} مليون`;
                sellSelect.appendChild(option);
            });
            
            // خيارات الشراء
            const buySelect = document.getElementById('buyPlayer');
            buySelect.innerHTML = '<option value="">اختر لاعب للشراء</option>';
            
            gameData.players.forEach(player => {
                // تحقق من أن اللاعب ليس في الفريق
                const isInTeam = Object.values(team).some(selectedPlayer => 
                    selectedPlayer && selectedPlayer.id === player.id
                );
                
                if (!isInTeam) {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name} (${player.team}) - ${player.price} مليون`;
                    buySelect.appendChild(option);
                }
            });
            
            // خيارات نقل البدلاء للأساسي
            const subSelect = document.getElementById('substituteToMain');
            subSelect.innerHTML = '<option value="">اختر لاعب من البدلاء</option>';
            
            ['substitute1', 'substitute2'].forEach(position => {
                if (team[position]) {
                    const option = document.createElement('option');
                    option.value = position;
                    option.textContent = `${team[position].name} (${team[position].team})`;
                    subSelect.appendChild(option);
                }
            });
        }

        // نقل لاعب من البدلاء للأساسي
        function moveToMain() {
            if (isGameweekActive()) {
                alert('لا يمكن نقل اللاعبين أثناء الجولة الجارية!');
                return;
            }
            const subPosition = document.getElementById('substituteToMain').value;
            
            if (!subPosition) {
                alert('يرجى اختيار لاعب من البدلاء');
                return;
            }
            
            const subPlayer = gameData.currentUser.team[subPosition];
            if (!subPlayer) {
                alert('اللاعب غير موجود');
                return;
            }
            
            // العثور على مركز فارغ في التشكيلة الأساسية
            let targetPosition = null;
            
            // البحث عن مركز فارغ مناسب لمركز اللاعب
            if (subPlayer.position === 'goalkeeper' && !gameData.currentUser.team.goalkeeper) {
                targetPosition = 'goalkeeper';
            } else if (subPlayer.position === 'defender' && !gameData.currentUser.team.defender) {
                targetPosition = 'defender';
            } else if (subPlayer.position === 'midfielder') {
                if (!gameData.currentUser.team.midfielder1) targetPosition = 'midfielder1';
                else if (!gameData.currentUser.team.midfielder2) targetPosition = 'midfielder2';
            } else if (subPlayer.position === 'forward' && !gameData.currentUser.team.forward) {
                targetPosition = 'forward';
            }
            
            if (!targetPosition) {
                alert('لا يوجد مركز فارغ مناسب في التشكيلة الأساسية');
                return;
            }
            
            // نقل اللاعب
            gameData.currentUser.team[targetPosition] = subPlayer;
            gameData.currentUser.team[subPosition] = null;
            
            updateUserData();
            updateTransferOptions();
            updateUI();
            
            alert(`تم نقل ${subPlayer.name} للتشكيلة الأساسية`);
        }

        // تحديث لوحة المتصدرين
        function updateLeaderboards() {
            // ترتيب النقاط الإجمالية
            const totalSorted = [...gameData.users].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
            const totalContainer = document.getElementById('totalLeaderboard');
            totalContainer.innerHTML = '';
            
            totalSorted.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                item.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="user-info">
                        <div class="username">${user.username}</div>
                        <div style="font-size: 0.9rem; color: #bbb;">${user.teamName}</div>
                    </div>
                    <div class="points">${user.totalPoints || 0}</div>
                `;
                
                totalContainer.appendChild(item);
            });
            
            // ترتيب الجولة الحالية
            const roundSorted = [...gameData.users].sort((a, b) => {
                const aPoints = a.roundPoints ? (a.roundPoints[gameData.currentRound] || 0) : 0;
                const bPoints = b.roundPoints ? (b.roundPoints[gameData.currentRound] || 0) : 0;
                return bPoints - aPoints;
            });
            
            const roundContainer = document.getElementById('roundLeaderboard');
            roundContainer.innerHTML = '';
            
            roundSorted.forEach((user, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                const roundPoints = user.roundPoints ? (user.roundPoints[gameData.currentRound] || 0) : 0;
                
                item.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="user-info">
                        <div class="username">${user.username}</div>
                        <div style="font-size: 0.9rem; color: #bbb;">${user.teamName}</div>
                    </div>
                    <div class="points">${roundPoints}</div>
                `;
                
                roundContainer.appendChild(item);
            });
        }

        // تحديث إحصائيات اللاعبين
        function updatePlayerStats() {
            // حساب الإحصائيات الإجمالية لكل لاعب
            const playersWithStats = gameData.players.map(player => {
                const totalGoals = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.goals || 0), 0);
                const totalAssists = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.assists || 0), 0);
                const totalYellowCards = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.yellowCards || 0), 0);
                const totalRedCards = Object.values(player.stats.rounds).reduce((sum, round) => sum + (round.redCards || 0), 0);
                
                return {
                    ...player,
                    totalGoals,
                    totalAssists,
                    totalYellowCards,
                    totalRedCards
                };
            });
            
            // أكثر اللاعبين تهديفاً
            const topScorers = [...playersWithStats].sort((a, b) => b.totalGoals - a.totalGoals).slice(0, 10);
            updateStatLeaderboard('topScorers', topScorers, 'totalGoals', 'هدف');
            
            // أكثر اللاعبين تمريراً حاسماً
            const topAssisters = [...playersWithStats].sort((a, b) => b.totalAssists - a.totalAssists).slice(0, 10);
            updateStatLeaderboard('topAssisters', topAssisters, 'totalAssists', 'تمريرة');
            
            // أكثر اللاعبين إنذاراً
            const mostYellow = [...playersWithStats].sort((a, b) => b.totalYellowCards - a.totalYellowCards).slice(0, 10);
            updateStatLeaderboard('mostYellowCards', mostYellow, 'totalYellowCards', 'إنذار');
            
            // أكثر اللاعبين طرداً
            const mostRed = [...playersWithStats].sort((a, b) => b.totalRedCards - a.totalRedCards).slice(0, 10);
            updateStatLeaderboard('mostRedCards', mostRed, 'totalRedCards', 'طرد');
        }

        // تحديث لوحة إحصائيات محددة
        function updateStatLeaderboard(containerId, players, statKey, statLabel) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            players.forEach((player, index) => {
                if (player[statKey] === 0 && index > 2) return; // لا تظهر اللاعبين بدون إحصائيات بعد أول 3
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                item.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="user-info">
                        <div class="username">${player.name}</div>
                        <div style="font-size: 0.9rem; color: #bbb;">${player.team}</div>
                    </div>
                    <div class="points">${player[statKey]} ${statLabel}</div>
                `;
                
                container.appendChild(item);
            });
        }

        // إضافة باقي وظائف الإدارة
        function updateAdminMatchesList() {
            const container = document.getElementById('adminMatchesList');
            container.innerHTML = '';
            
            gameData.matches.forEach(match => {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'card';
                matchDiv.innerHTML = `
                    <h5>${match.team1} VS ${match.team2}</h5>
                    <p>الجولة: ${gameData.rounds.find(r => r.id === match.roundId)?.name || 'غير محددة'}</p>
                    <p>التاريخ: ${new Date(match.dateTime).toLocaleDateString('ar-EG')}</p>
                    <p>الحالة: ${match.status === 'upcoming' ? 'قادمة' : 'انتهت'}</p>
                    ${match.score.team1 !== null ? `<p>النتيجة: ${match.score.team1} - ${match.score.team2}</p>` : ''}
                    <button onclick="editMatch(${match.id})" class="btn btn-warning">تعديل النتيجة</button>
                    <button onclick="deleteMatch(${match.id})" class="btn btn-danger">حذف</button>
                `;
                container.appendChild(matchDiv);
            });
        }

        function addTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            if (!teamName) {
                alert('يرجى إدخال اسم الفريق');
                return;
            }
            
            if (gameData.teams.find(t => t.name === teamName)) {
                alert('اسم الفريق موجود بالفعل');
                return;
            }
            
            const newTeam = {
                id: Date.now(),
                name: teamName
            };
            
            gameData.teams.push(newTeam);
            document.getElementById('newTeamName').value = '';
            saveGameData();
            updateTeamsList();
            updateTeamOptions();
            
            alert('تم إضافة الفريق بنجاح');
        }

        function updateTeamsList() {
            const container = document.getElementById('teamsList');
            container.innerHTML = '';
            
            gameData.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'card';
                teamDiv.innerHTML = `
                    <h5>${team.name}</h5>
                    <button onclick="deleteTeam(${team.id})" class="btn btn-danger">حذف</button>
                `;
                container.appendChild(teamDiv);
            });
        }

        function updatePlayerTeamOptions() {
            const select = document.getElementById('newPlayerTeam');
            select.innerHTML = '<option value="">اختر الفريق</option>';
            
            gameData.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.name;
                option.textContent = team.name;
                select.appendChild(option);
            });
        }

        function savePlayer() {
            const playerId = document.getElementById('editPlayerId').value;
            const name = document.getElementById('newPlayerName').value.trim();
            const team = document.getElementById('newPlayerTeam').value;
            const position = document.getElementById('newPlayerPosition').value;
            const price = parseFloat(document.getElementById('newPlayerPrice').value);
            
            if (!name || !team || !position || !price) {
                alert('يرجى ملء جميع حقول اللاعب');
                return;
            }
            
            if (price <= 0) {
                alert('يرجى إدخال سعر صحيح للاعب');
                return;
            }
            
            if (playerId) { // Edit existing player
                const playerIndex = gameData.players.findIndex(p => p.id === parseInt(playerId));
                if (playerIndex !== -1) {
                    gameData.players[playerIndex].name = name;
                    gameData.players[playerIndex].team = team;
                    gameData.players[playerIndex].position = position;
                    gameData.players[playerIndex].price = price;
                    alert('تم تعديل اللاعب بنجاح');
                }
            } else { // Add new player
            const newPlayer = {
                id: Date.now(),
                name,
                team,
                position,
                price,
                stats: { rounds: {} },
                injured: false
            };
            gameData.players.push(newPlayer);
                alert('تم إضافة اللاعب بنجاح');
            }
            
            // Clear form and reset edit state
            document.getElementById('editPlayerId').value = '';
            document.getElementById('newPlayerName').value = '';
            document.getElementById('newPlayerTeam').value = '';
            document.getElementById('newPlayerPosition').value = 'goalkeeper';
            document.getElementById('newPlayerPrice').value = '';
            document.getElementById('savePlayerBtn').textContent = 'إضافة لاعب';
            
            saveGameData();
            updatePlayersAdminList();
            updatePlayerPointsOptions(); // Update options for points management
        }

        function editPlayer(playerId) {
            const player = gameData.players.find(p => p.id === playerId);
            if (player) {
                document.getElementById('editPlayerId').value = player.id;
                document.getElementById('newPlayerName').value = player.name;
                document.getElementById('newPlayerTeam').value = player.team;
                document.getElementById('newPlayerPosition').value = player.position;
                document.getElementById('newPlayerPrice').value = player.price;
                document.getElementById('savePlayerBtn').textContent = 'تعديل اللاعب';
            }
        }

        function updatePlayersAdminList() {
            const container = document.getElementById('playersAdminList');
            container.innerHTML = '';

            gameData.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'card';
                playerDiv.innerHTML = `
                    <h5>${player.name} (${player.team})</h5>
                    <p>المركز: ${player.position}</p>
                    <p>السعر: ${player.price} مليون</p>
                    <button onclick="editPlayer(${player.id})" class="btn btn-warning">تعديل</button>
                    <button onclick="deletePlayer(${player.id})" class="btn btn-danger">حذف</button>
                `;
                container.appendChild(playerDiv);
            });
        }

        function updatePlayerPointsOptions() {
            const select = document.getElementById('pointsPlayerId');
            select.innerHTML = '<option value="">اختر اللاعب</option>';
            
            gameData.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `${player.name} (${player.team})`;
                select.appendChild(option);
            });
            
            // إظهار/إخفاء حقل التصديات حسب المركز
            select.addEventListener('change', function() {
                const playerId = parseInt(this.value);
                const player = gameData.players.find(p => p.id === playerId);
                const savesGroup = document.getElementById('savesMGroup');
                
                if (player && player.position === 'goalkeeper') {
                    savesGroup.style.display = 'block';
                } else {
                    savesGroup.style.display = 'none';
                }
            });
        }

        function updatePointsRoundOptions() {
            const select = document.getElementById('pointsRound');
            select.innerHTML = '<option value="">اختر الجولة</option>';
            
            gameData.rounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round.id;
                option.textContent = round.name;
                select.appendChild(option);
            });
        }

        function updatePlayerPoints() {
            const playerId = parseInt(document.getElementById('pointsPlayerId').value);
            const roundId = parseInt(document.getElementById('pointsRound').value);
            const directPoints = parseInt(document.getElementById('directPoints').value) || 0;
            const goals = parseInt(document.getElementById('playerGoals').value) || 0;
            const assists = parseInt(document.getElementById('playerAssists').value) || 0;
            const yellowCards = parseInt(document.getElementById('playerYellowCards').value) || 0;
            const redCards = parseInt(document.getElementById('playerRedCards').value) || 0;
            const saves = parseInt(document.getElementById('playerSaves').value) || 0;
            const injured = document.getElementById('playerInjured').checked;
            
            if (!playerId || !roundId) {
                alert('يرجى اختيار لاعب وجولة');
                return;
            }
            
            const playerIndex = gameData.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                alert('اللاعب غير موجود');
                return;
            }
            
            // تحديث إحصائيات اللاعب
            if (!gameData.players[playerIndex].stats.rounds[roundId]) {
                gameData.players[playerIndex].stats.rounds[roundId] = {};
            }
            
            gameData.players[playerIndex].stats.rounds[roundId] = {
                directPoints,
                goals,
                assists,
                yellowCards,
                redCards,
                saves,
                injured
            };
            
            gameData.players[playerIndex].injured = injured;
            
            saveGameData();
            
            // تحديث نقاط جميع المستخدمين
            updateAllUserPoints();
            
            alert('تم تحديث نقاط اللاعب بنجاح');
        }

        // تحديث نقاط جميع المستخدمين
        function updateAllUserPoints() {
            gameData.users.forEach(user => {
                let totalPoints = 0;
                const roundPoints = {};
                
                // حساب النقاط لكل جولة
                gameData.rounds.forEach(round => {
                    let roundTotal = 0;
                    
                    const team = user.team;
                    Object.keys(team).forEach(position => {
                        if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound'].includes(position) || !team[position]) return;
                        
                        const player = gameData.players.find(p => p.id === team[position].id);
                        if (!player) return;
                        
                        const playerRoundStats = player.stats.rounds[round.id] || {};
                        let playerPoints = playerRoundStats.directPoints || 0;
                        
                        // حساب النقاط من الإحصائيات
                        playerPoints += (playerRoundStats.goals || 0) * 4;
                        playerPoints += (playerRoundStats.assists || 0) * 3;
                        playerPoints -= (playerRoundStats.yellowCards || 0) * 1;
                        playerPoints -= (playerRoundStats.redCards || 0) * 3;
                        
                        if (player.position === 'goalkeeper') {
                            playerPoints += (playerRoundStats.saves || 0) * 1;
                        }
                        
                        // التحقق من الإصابة واستبدال اللاعب المصاب
                        if (playerRoundStats.injured && !['substitute1', 'substitute2'].includes(position)) {
                            // استخدام اللاعب السادس (أول بديل)
                            if (team.substitute1) {
                                const substitute = gameData.players.find(p => p.id === team.substitute1.id);
                                if (substitute && !substitute.stats.rounds[round.id]?.injured) {
                                    const subStats = substitute.stats.rounds[round.id] || {};
                                    playerPoints = subStats.directPoints || 0;
                                    playerPoints += (subStats.goals || 0) * 4;
                                    playerPoints += (subStats.assists || 0) * 3;
                                    playerPoints -= (subStats.yellowCards || 0) * 1;
                                    playerPoints -= (subStats.redCards || 0) * 3;
                                    
                                    if (substitute.position === 'goalkeeper') {
                                        playerPoints += (subStats.saves || 0) * 1;
                                    }
                                }
                            }
                        }
                        
                        // تطبيق ضاعف الكابتن أو التريبل كابتن
                        if (team.captain === player.id) {
                            if (team.tripleCaptain === player.id && team.tripleCaptainRound === round.id) {
                                playerPoints *= 3; // التريبل كابتن
                            } else {
                                playerPoints *= 2; // الكابتن العادي
                            }
                        }
                        
                        roundTotal += Math.max(0, playerPoints);
                    });
                    
                    // إضافة نقاط البدلاء إذا تم استخدام البينش بوست
                    if (team.benchBoostRound === round.id) {
                        ['substitute1', 'substitute2'].forEach(position => {
                            if (team[position]) {
                                const player = gameData.players.find(p => p.id === team[position].id);
                                if (player) {
                                    const playerRoundStats = player.stats.rounds[round.id] || {};
                                    let benchPlayerPoints = playerRoundStats.directPoints || 0;
                                    benchPlayerPoints += (playerRoundStats.goals || 0) * 4;
                                    benchPlayerPoints += (playerRoundStats.assists || 0) * 3;
                                    benchPlayerPoints -= (playerRoundStats.yellowCards || 0) * 1;
                                    benchPlayerPoints -= (playerRoundStats.redCards || 0) * 3;
                                    
                                    if (player.position === 'goalkeeper') {
                                        benchPlayerPoints += (playerRoundStats.saves || 0) * 1;
                                    }
                                    
                                    roundTotal += Math.max(0, benchPlayerPoints);
                                }
                            }
                        });
                    }
                    
                    roundPoints[round.id] = roundTotal;
                    totalPoints += roundTotal;
                });
                
                user.totalPoints = totalPoints;
                user.roundPoints = roundPoints;
            });
            
            saveGameData();
            
            // تحديث المستخدم الحالي إذا كان ضمن المستخدمين المحدثين
            const currentUserUpdated = gameData.users.find(u => u.id === gameData.currentUser.id);
            if (currentUserUpdated) {
                gameData.currentUser = currentUserUpdated;
                localStorage.setItem('currentUser', JSON.stringify(gameData.currentUser));
                updateTeamStats();
            }
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
        });

        async function deleteTeam(teamId) {
            if (confirm('هل أنت متأكد من حذف هذا الفريق؟ سيتم حذف جميع اللاعبين المرتبطين به أيضاً.')) {
                const deleteRes = await callApi(`teams.php?id=${teamId}`, 'DELETE');

                if (deleteRes && deleteRes.status === 'success') {
                    alert('تم حذف الفريق وجميع اللاعبين المرتبطين به بنجاح!');
                    await updateAdminData(); // Refresh all admin lists
                } else {
                    alert(deleteRes.message || 'فشل حذف الفريق. يرجى المحاولة مرة أخرى.');
                }
            }
        }

        async function confirmDeleteUser() {
            const usernameToDelete = document.getElementById('deleteUserSearch').value.trim();
            if (!usernameToDelete) {
                alert('يرجى إدخال اسم المستخدم للحذف');
                return;
            }

            const user = gameData.users.find(u => u.username === usernameToDelete);
            if (!user) {
                alert('المستخدم غير موجود');
                return;
            }

            if (confirm(`هل أنت متأكد من حذف حساب المستخدم ${usernameToDelete}؟`)) {
                deleteUser(user.id);
            }
        }

        function deleteUser(userId) {
            gameData.users = gameData.users.filter(user => user.id !== userId);
            saveGameData();
            // Optionally, clear the search input
            document.getElementById('deleteUserSearch').value = '';
            alert('تم حذف الحساب بنجاح');
            updateAdminData(); // Refresh admin user list
        }

        function deletePlayer(playerId) {
            if (confirm('هل أنت متأكد من حذف هذا اللاعب؟')) {
                const deletedPlayer = gameData.players.find(p => p.id === playerId);
                gameData.players = gameData.players.filter(player => player.id !== playerId);

                if (deletedPlayer) {
                    gameData.users.forEach(user => {
                        let userTeamChanged = false;
                        Object.keys(user.team).forEach(position => {
                            if (user.team[position] && user.team[position].id === playerId) {
                                user.team[position] = null;
                                user.budget += deletedPlayer.price;
                                user.transfersRemaining++; // Grant a free transfer
                                userTeamChanged = true;
                                alert(`تم إزالة اللاعب ${deletedPlayer.name} من فريق ${user.teamName} وإعادة ${deletedPlayer.price} مليون للميزانية. وتم منح تبديل مجاني.`);
                            }
                        });
                        
                        // Also check for captain/triple captain
                        if (user.team.captain === playerId) user.team.captain = null;
                        if (user.team.tripleCaptain === playerId) user.team.tripleCaptain = null;

                        if (userTeamChanged) {
                            const userIndex = gameData.users.findIndex(u => u.id === user.id);
                            if (userIndex !== -1) {
                                gameData.users[userIndex] = user;
                                if (gameData.currentUser && gameData.currentUser.id === user.id) {
                                    gameData.currentUser = user;
                                    localStorage.setItem('currentUser', JSON.stringify(user));
                                    updateUI(); // Ensure UI is updated for current user if their team was affected
                                }
                            }
                        }
                    });
                }
                saveGameData();
                updatePlayersAdminList();
                updatePlayerPointsOptions(); // Update options for points management
                // Additionally, force a general UI update for the current user in case of any remaining inconsistencies.
                if (gameData.currentUser) {
                    updateUI(); 
                }
                alert('تم حذف اللاعب بنجاح');
            }
        }

        // Helper to check if current gameweek is active
        function isGameweekActive() {
            const currentRound = gameData.rounds.find(r => r.id === gameData.currentRound);
            if (!currentRound) return false;

            const now = new Date();
            const startDate = new Date(currentRound.startDate);
            const endDate = new Date(currentRound.endDate);

            return now >= startDate && now <= endDate;
        }

        // Helper to determine if user is still in initial team building phase
        function isInitialTeamBuildingPhase() {
            if (!gameData.currentUser || !gameData.currentUser.team) return false;
            const filledSlotsCount = Object.keys(gameData.currentUser.team)
                                        .filter(key => !['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound', 'freeTransfers'].includes(key))
                                        .filter(key => gameData.currentUser.team[key] !== null)
                                        .length;
            return filledSlotsCount < 7; // Assuming 7 main players (GK, DEF, MID1, MID2, FWD, SUB1, SUB2)
        }

        // تبديل وضع الانتقالات
        async function toggleTransferMode() {
            if (isGameweekActive()) {
                alert('لا يمكن إدارة الانتقالات أثناء الجولة الجارية!');
                return;
            }

            gameData.isTransferMode = !gameData.isTransferMode;
            const toggleBtn = document.getElementById('toggleTransferModeBtn');
            const transferActionButtons = document.getElementById('transferActionButtons');

            if (gameData.isTransferMode) {
                // Enter transfer mode
                gameData.stagedTeam = { ...gameData.currentUser.team };
                gameData.stagedBudget = gameData.currentUser.budget;
                toggleBtn.textContent = 'إلغاء الانتقالات';
                transferActionButtons.classList.remove('hidden');
            } else {
                // Exit transfer mode (implicitly discard changes if not saved)
                gameData.stagedTeam = null;
                gameData.stagedBudget = 0;
                toggleBtn.textContent = 'إدارة الانتقالات';
                transferActionButtons.classList.add('hidden');
            }
            updateUI();
        }

        // Handle clicks on player slots
        async function handlePlayerSlotClick(slotKey) {
            if (!gameData.currentUser) {
                alert('يرجى تسجيل الدخول أولاً.');
                return;
            }

            // Allow initial team building (up to 7 players) without transfer mode
            if (isInitialTeamBuildingPhase()) {
                await openPlayerSelection(slotKey, true); // Force open selection if team is not full yet
            } else if (gameData.isTransferMode) {
                const playerInSlot = gameData.stagedTeam[slotKey];
                if (playerInSlot) {
                    // Remove player from staged team
                    gameData.stagedBudget += playerInSlot.price;
                    gameData.stagedTeam[slotKey] = null;
                    await updateUI(); // Refresh UI to reflect removal and budget change
                } else {
                    // Open selection for empty slot in transfer mode
                    await openPlayerSelection(slotKey);
                }
            } else {
                alert('لإجراء تغييرات على اللاعبين، يرجى الدخول إلى وضع إدارة الانتقالات أولاً.');
            }
        }

        // حفظ التبديلات
        function saveTransfers() {
            if (isGameweekActive()) {
                alert('لا يمكن حفظ التبديلات أثناء الجولة الجارية!');
                return;
            }

            let transfersMade = 0;
            const currentTeam = gameData.currentUser.team;
            const stagedTeam = gameData.stagedTeam;

            // Compare currentTeam with stagedTeam to count actual changes
            Object.keys(currentTeam).forEach(position => {
                // Exclude captain and power-up related properties
                if (['captain', 'tripleCaptain', 'tripleCaptainUsed', 'benchBoostUsed', 'benchBoostRound', 'freeTransfers'].includes(position)) return;

                const currentPlayer = currentTeam[position];
                const stagedPlayer = stagedTeam[position];

                if (currentPlayer && !stagedPlayer) {
                    transfersMade++; // Player removed
                } else if (!currentPlayer && stagedPlayer) {
                    transfersMade++; // Player added to an empty slot
                } else if (currentPlayer && stagedPlayer && currentPlayer.id !== stagedPlayer.id) {
                    transfersMade++; // Player swapped
                }
            });

            // Apply transfer limits only if actual transfers were made
            if (transfersMade > 0) {
                if (gameData.currentUser.freeTransfers > 0) {
                    gameData.currentUser.freeTransfers--;
                    alert(`تم حفظ التبديلات بنجاح! تم استخدام تبديل مجاني. تبقى لديك ${gameData.currentUser.freeTransfers} تبديل مجاني.`);
                } else if (gameData.currentUser.transfersRemaining > 0) {
                    gameData.currentUser.transfersRemaining--;
                    alert(`تم حفظ التبديلات بنجاح! تبقى لديك ${gameData.currentUser.transfersRemaining} تبديل مدفوع.`);
                } else {
                    alert('لا يمكنك إجراء المزيد من التبديلات. يرجى تجاهل التبديلات أو الانتظار للجولة التالية.');
                    return; // Prevent saving if no transfers remaining
                }
            }

            // Finalize changes
            gameData.currentUser.team = { ...gameData.stagedTeam };
            gameData.currentUser.budget = gameData.stagedBudget;

            gameData.isTransferMode = false;
            gameData.stagedTeam = null;
            gameData.stagedBudget = 0;
            updateUserData();
            updateUI();

            // Reset the toggle button text after saving
            document.getElementById('toggleTransferModeBtn').textContent = 'إدارة الانتقالات';
            document.getElementById('transferActionButtons').classList.add('hidden');
        }

        // تجاهل التبديلات
        function discardTransfers() {
            gameData.isTransferMode = false;
            gameData.stagedTeam = null;
            gameData.stagedBudget = 0;
            updateUI();

            // Reset the toggle button text after discarding
            document.getElementById('toggleTransferModeBtn').textContent = 'إدارة الانتقالات';
            document.getElementById('transferActionButtons').classList.add('hidden');
        }

        function updateUsersList() {
            const container = document.getElementById('usersAdminList');
            container.innerHTML = '';
            gameData.users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'card';
                userDiv.innerHTML = `
                    <h5>${user.username} - ${user.teamName}</h5>
                    <p>النقاط الإجمالية: ${user.totalPoints || 0}</p>
                    <button onclick="deleteUser(${user.id})" class="btn btn-danger">حذف</button>
                `;
                container.appendChild(userDiv);
            });
        }

        function confirmDeleteUser() {
            const usernameToDelete = document.getElementById('deleteUserSearch').value.trim();
            if (!usernameToDelete) {
                alert('يرجى إدخال اسم المستخدم للحذف');
                return;
            }
            const user = gameData.users.find(u => u.username === usernameToDelete);
            if (!user) {
                alert('المستخدم غير موجود');
                return;
            }
            if (confirm(`هل أنت متأكد من حذف حساب المستخدم ${usernameToDelete}؟`)) {
                deleteUser(user.id);
            }
        }

        function deleteUser(userId) {
            gameData.users = gameData.users.filter(user => user.id !== userId);
            saveGameData();
            document.getElementById('deleteUserSearch').value = '';
            alert('تم حذف الحساب بنجاح');
            updateUsersList(); // Refresh admin user list
            // Optionally, if the deleted user was the current user, log them out
            if (gameData.currentUser && gameData.currentUser.id === userId) {
                logout();
            }
        }
    </script>
</body>
</html>
</html>